# Moonshot: базовая модель для анализа исследований рентгенографии грудной клетки

![logo](logo.jpg)

## Введение

Moonshot — это нейросеть, которая была обучена на базе 1 миллиона рентгенографических исследований грудной клетки. Для обучения использовались только доступные текстовые заключения и описания этих исследований, написанные врачами-рентгенологами в ходе их профессиональной деятельности. Специализированная разметка этих исследований не проводилась.

Благодаря огромному количеству и разнообразию примеров, используемых для обучения, Moonshot способен распознавать и локализовать широкий спектр патологий с более высоким качеством по сравнению с моделями, которые обучаются на ограниченных выборках со специализированной разметкой.

Однако, поскольку Moonshot не обучался на специализированной разметке для классификации и сегментации, он не способен предоставлять информацию о наличии и локализации патологий в виде вероятностей и контуров. Он возвращает эту информацию в "закодированном" виде, который с точки зрения пользователя представляет собой абстрактный набор чисел, так называемое векторное представление. Для того чтобы получать из этих векторных представлений вероятности и контуры патологий, требуется дообучать "декодировщик" на специализированной разметке с использованием меток и контуров.

Возникает вопрос: чем же тогда Moonshot лучше других моделей, если для его применения на практике также требуется обучение на специализированной разметке?
Ответ: для того, чтобы дообучить Moonshot до требуемого качества классификации и локализации, достаточно разметить выборку, которая на несколько порядков меньше, чем требуется для обучения моделей "с нуля".

## Руководство пользователя

### Системные требования

* GPU с 16Gb видеопамяти и с поддержкой CUDA;

* [NVIDIA CUDA Toolkit](https://developer.nvidia.com/cuda-toolkit]).


### Подготовка окружения

Мы рекомендуем установить пакетный менеджер `Miniconda`, следуя инструкциям на [сайте](https://docs.anaconda.com/miniconda/), и создать отдельный `conda environment`:
```
conda create -n moonshot python=3.10
conda activate moonshot
```

### Установка пакетов

Затем, установите пакет `torch>=2.5.1`, следуя инструкциям на [сайте](https://pytorch.org/), и выбрав версию совместимую с вашей версией `CUDA`.

Для того, чтобы установить все остальные зависимости, выполните следующую команду, находясь в корневой директории данного репозитория:
```
pip install -e.
```

Также установите jupyter-ядро, для того чтобы использовать установленные пакеты в jupyter-ноутбуках:
```
ipython kernel install --user --name=moonshot
```

### Файл с моделью

Модель Moonshot находится в файле `moonshot.pt`, который передается пользователю вместе с данным репозиторием на физическом носителе.

Также этот файл можно загрузить по [ссылке](https://b24.2a2i.org/~JAB2m). Ссылка защищена паролем, который передается пользователю отдельно от данного репозитория.

### Минимальный пример использования

```python
import pydicom

import torch

from moonshot.model import moonshot
from moonshot.image_processor import ImageProcessor


# model - это объект класса timm.models.vision_transformer.VisionTransformer c подгруженными предобученными весами.
# Его можно использовать как вставной модуль в моделях для классификации, сегментации или других задач.
model = moonshot(model_filepath='D:/moonshot.pt')  # требуется передать путь до загруженного файла `moonshot.pt`

# image_processor - это объект, который отвечает за препроцессинг изображений,
# который необходим перед тем как подавать их в модель
image_processor = ImageProcessor()

dicom = pydicom.dcmread('/path/to/image.dcm')  # подгружаем DICOM с диска
image = image_processor.preprocess_dicom(dicom)  # DICOM -> PIL
image = image_processor(image)  # PIL -> torch.Tensor, тензор размера (1, 3, 518, 518)

# инференс модели
model.eval()
with torch.inference_mode():
    features, intermediates = model.forward_intermediates(image, return_prefix_tokens=True, output_fmt='NLC')

last_cls_token = features[:, 0]  # классификационный токен, тензор размера (1, 1024)
last_reg_tokens = features[:, 1:5]  # 4 токена-регистра, тензор размера (1, 4, 1024)
last_patch_tokens = features[:, 5:]  # (518 // 14) ** 2 = 1369 патч-токенов, тензор размера (1, 1369, 1024)

# для некоторых задач может быть полезно брать токены не с последнего, а с предпоследнего слоя
hidden_cls_token = intermediates[-2][1][:, 0]  # тензор размера (1, 1024)
hidden_reg_tokens = intermediates[-2][1][:, 1:]  # тензор размера (1, 4, 1024)
hidden_patch_tokens = intermediates[-2][0]  # тензор размера (1, 1369, 1024)

```

### Подробные примеры использования

* [Пример 1: обучение классификаторов на основе Moonshot](notebooks/classification.ipynb)

### Инструкция по запуску jupyter-ноутбуков

В [VSCode](https://code.visualstudio.com/) есть расширение `Python`, которое включает в себя поддержку jupyter-ноутбуков. Поэтому рекомендуем открыть репозиторий через VSCode и запускать jupyter-ноутбуки в нём.

Также jupyter-ноутбуки можно запускать через терминал. Выполните следующую команду, находясь в корне репозитория
```
jupyter notebook --port 8888
```

Затем введите адрес `localhost:8888` в браузере, перейдите в папку notebooks и запустите нужный ноутбук.

Если вы запустили команду `jupyter notebook --port 8888` на удаленном сервере, то для того, чтобы открыть jupyter через браузер, вам нужно "прокинуть" порт:
```
ssh -N -f -L localhost:8888:localhost:8888 <your_host_name>
```

Не забудьте выбрать установленное jupyter-ядро `moonshot`.
